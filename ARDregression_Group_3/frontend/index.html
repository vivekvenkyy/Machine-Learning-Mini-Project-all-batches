<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADR Regression Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .plot-container {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            width: 100%;
        }

        .plot-div {
            width: 100%;
            min-height: 500px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        @media (max-width: 768px) {
            .plot-div {
                min-height: 300px;
            }
        }

        .results-container {
            margin-top: 20px;
        }

        .validation-results {
            margin-top: 15px;
        }

        .error {
            color: #dc3545;
            margin-top: 10px;
        }

        .warning {
            color: #ffc107;
            margin-top: 10px;
        }

        .success {
            color: #28a745;
            margin-top: 10px;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .progress {
            height: 10px;
            margin-top: 5px;
            border-radius: 5px;
            background-color: #e9ecef;
        }

        .progress-bar {
            transition: width 0.6s ease;
            border-radius: 5px;
        }

        .feature-relevance {
            font-size: 0.9rem;
        }

        .card {
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">ADR Regression Analysis</h1>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Step 1: Upload and Validate Dataset</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm">
                    <div class="mb-3">
                        <label for="datasetFile" class="form-label">Choose CSV File</label>
                        <input type="file" class="form-control" id="datasetFile" accept=".csv" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Validate Dataset</button>
                </form>
                <div id="validationLoader" class="loader"></div>
                <div id="validationResults" class="validation-results"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Step 2: Train Model</h5>
            </div>
            <div class="card-body">
                <form id="trainingForm">
                    <div class="mb-3">
                        <label for="targetColumn" class="form-label">Select Target Column</label>
                        <select class="form-select" id="targetColumn" required disabled>
                            <option value="">Select a column...</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success" disabled>Train Model</button>
                </form>
                <div id="trainingLoader" class="loader"></div>
                <div id="trainingResults" class="results-container"></div>
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Model Visualizations</h5>
                                <div class="plot-container mb-4">
                                    <h6>Feature Importance Analysis</h6>
                                    <div id="featureImportancePlot" class="plot-div"></div>
                                </div>
                                <div class="plot-container">
                                    <h6>Model Performance Plot</h6>
                                    <div id="predictionPlot" class="plot-div"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Step 3: Make Predictions</h5>
            </div>
            <div class="card-body">
                <form id="predictionForm">
                    <div class="mb-3">
                        <label for="predictionFile" class="form-label">Upload New Data (CSV)</label>
                        <input type="file" class="form-control" id="predictionFile" accept=".csv" required disabled>
                    </div>
                    <button type="submit" class="btn btn-primary" disabled>Generate Predictions</button>
                </form>
                <div id="predictionLoader" class="loader"></div>
                <div id="predictionResults" class="results-container"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api';
        let isModelTrained = false;

        // Helper function to create the stats section
        function createStatsSection(stats) {
            return `
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Prediction Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <p><strong>Mean:</strong> ${stats.mean.toFixed(2)}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>Median:</strong> ${stats.median.toFixed(2)}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>Std Dev:</strong> ${stats.std.toFixed(2)}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>Count:</strong> ${stats.count}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to create the predictions table
        function createPredictionsTable(predictions) {
            const headers = Object.keys(predictions[0] || {});
            return `
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            ${headers.map(header => `<th>${header}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${predictions.map(row => `
                            <tr>
                                ${headers.map(header => `<td>${row[header]}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Helper function to create visualization tabs
        function createVisualizationTabs() {
            return `
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" data-bs-toggle="tab" href="#distributionTab">Distribution</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#timeSeriesTab">Time Series</a>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div class="tab-content">
                                    <div class="tab-pane fade show active" id="distributionTab">
                                        <div id="distributionPlot" class="plot-div"></div>
                                    </div>
                                    <div class="tab-pane fade" id="timeSeriesTab">
                                        <div id="timeSeriesPlot" class="plot-div"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to render plots
        function renderPlots(visualizations) {
            if (visualizations.distribution) {
                Plotly.newPlot('distributionPlot', 
                    visualizations.distribution.data,
                    {
                        ...visualizations.distribution.layout,
                        height: 400,
                        margin: { l: 50, r: 50, b: 50, t: 50, pad: 4 }
                    }
                );
            }

            if (visualizations.time_series) {
                Plotly.newPlot('timeSeriesPlot',
                    visualizations.time_series.data,
                    {
                        ...visualizations.time_series.layout,
                        height: 400,
                        margin: { l: 50, r: 50, b: 50, t: 50, pad: 4 }
                    }
                );
            }
        }

        // Function to safely render plots
        function renderPlots(visualizations) {
            try {
                if (visualizations.prediction_distribution) {
                    Plotly.newPlot('predictionDistributionPlot',
                        visualizations.prediction_distribution.data,
                        visualizations.prediction_distribution.layout || {}
                    );
                }

                if (visualizations.feature_importance) {
                    Plotly.newPlot('featureImportancePlot',
                        visualizations.feature_importance.data,
                        visualizations.feature_importance.layout || {}
                    );
                }

                if (visualizations.feature_impact) {
                    Plotly.newPlot('featureImpactPlot',
                        visualizations.feature_impact.data,
                        visualizations.feature_impact.layout || {}
                    );
                }
            } catch (error) {
                console.error('Error rendering plots:', error);
            }
        }

        // Helper functions for creating HTML sections
        function createStatsSection(stats) {
            // Helper function to safely format numbers
            const formatNumber = (num) => {
                return (typeof num === 'number' && !isNaN(num)) ? num.toFixed(4) : '0.0000';
            };

            return `
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Statistical Summary</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tbody>
                                <tr><th>Mean Prediction</th><td>${formatNumber(stats.mean)}</td></tr>
                                <tr><th>Standard Deviation</th><td>${formatNumber(stats.std)}</td></tr>
                                <tr><th>Minimum</th><td>${formatNumber(stats.min)}</td></tr>
                                <tr><th>Maximum</th><td>${formatNumber(stats.max)}</td></tr>
                                <tr><th>Median (Q2)</th><td>${formatNumber(stats.quartiles[1])}</td></tr>
                                <tr><th>Number of Predictions</th><td>${stats.count}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function createPredictionsTable(predictions) {
            console.log(predictions)
            return `
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Index</th>
                            <th>Predicted Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${predictions.slice(0, 100).map((pred, idx) => 
                            `<tr><td>${idx + 1}</td><td>${pred.toFixed(4)}</td></tr>`
                        ).join('')}
                    </tbody>
                </table>
                ${predictions.length > 100 ? 
                    `<div class="text-muted small">Showing first 100 of ${predictions.length} predictions</div>` 
                    : ''}
            `;
        }

        function createVisualizationTabs() {
            return `
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Analysis & Visualizations</h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="analysisTab" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="distribution-tab" data-bs-toggle="tab" href="#distribution" role="tab">
                                    Prediction Distribution
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="importance-tab" data-bs-toggle="tab" href="#importance" role="tab">
                                    Feature Importance
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="impact-tab" data-bs-toggle="tab" href="#impact" role="tab">
                                    Feature Impact
                                </a>
                            </li>
                        </ul>
                        
                        <div class="tab-content mt-3" id="analysisTabContent">
                            <div class="tab-pane fade show active" id="distribution" role="tabpanel">
                                <div id="predictionDistributionPlot" class="plot-div"></div>
                            </div>
                            <div class="tab-pane fade" id="importance" role="tabpanel">
                                <div id="featureImportancePlot" class="plot-div"></div>
                            </div>
                            <div class="tab-pane fade" id="impact" role="tabpanel">
                                <div id="featureImpactPlot" class="plot-div"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Utility functions
        const showLoader = (id) => document.getElementById(id).style.display = 'block';
        const hideLoader = (id) => document.getElementById(id).style.display = 'none';
        const showError = (containerId, message) => {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="error">${message}</div>`;
        };

        // Handle dataset validation
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('datasetFile');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            showLoader('validationLoader');
            try {
                const response = await fetch(`${API_BASE_URL}/validate`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                const resultsContainer = document.getElementById('validationResults');
                const targetSelect = document.getElementById('targetColumn');

                if (data.is_valid) {
                    resultsContainer.innerHTML = '<div class="success">Dataset is valid!</div>';
                    
                    // Populate target column dropdown
                    targetSelect.innerHTML = '<option value="">Select a column...</option>';
                    data.validation_results.columns.numeric.forEach(col => {
                        targetSelect.innerHTML += `<option value="${col}">${col}</option>`;
                    });
                    targetSelect.disabled = false;
                    document.querySelector('#trainingForm button').disabled = false;
                } else {
                    let errorHtml = '<div class="error"><strong>Validation Errors:</strong><ul>';
                    data.validation_results.errors.forEach(error => {
                        errorHtml += `<li>${error}</li>`;
                    });
                    errorHtml += '</ul></div>';
                    
                    if (data.validation_results.warnings.length > 0) {
                        errorHtml += '<div class="warning"><strong>Warnings:</strong><ul>';
                        data.validation_results.warnings.forEach(warning => {
                            errorHtml += `<li>${warning}</li>`;
                        });
                        errorHtml += '</ul></div>';
                    }
                    resultsContainer.innerHTML = errorHtml;
                }
            } catch (error) {
                showError('validationResults', 'Error validating dataset: ' + error.message);
            } finally {
                hideLoader('validationLoader');
            }
        });

        // Handle model training
        document.getElementById('trainingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('datasetFile');
            const targetColumn = document.getElementById('targetColumn').value;
            if (!fileInput.files[0] || !targetColumn) return;

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('target_column', targetColumn);

            showLoader('trainingLoader');
            try {
                const response = await fetch(`${API_BASE_URL}/train`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                const resultsContainer = document.getElementById('trainingResults');
                // Normalize feature relevance scores to 0-100
                const relevanceScores = data.training_results.relevant_features || {};
                const scores = Object.values(relevanceScores);
                const maxScore = scores.length > 0 ? Math.max(...scores) : 1;
                const normalizedScores = {};
                Object.entries(relevanceScores).forEach(([feature, score]) => {
                    normalizedScores[feature] = (score / maxScore) * 100;
                });

                // Sort features by relevance score
                const sortedFeatures = Object.entries(normalizedScores)
                    .sort((a, b) => b[1] - a[1]);

                resultsContainer.innerHTML = `
                    <h4 class="mb-4">Training Results:</h4>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Model Performance Metrics</h5>
                                    <p>Train RMSE: ${data.training_results.train_rmse.toFixed(4)}</p>
                                    <p>Test RMSE: ${data.training_results.test_rmse.toFixed(4)}</p>
                                    <p>Train R²: ${data.training_results.train_r2.toFixed(4)}</p>
                                    <p>Test R²: ${data.training_results.test_r2.toFixed(4)}</p>
                                    <p>Overall Score: ${data.training_results.score.toFixed(4)}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Feature Relevance Scores</h5>
                                    <p>Max Score: ${data.training_results.max_score.toFixed(4)}</p>
                                    ${Object.entries(data.training_results.normalized_scores).sort((a, b) => b[1] - a[1]).map(([feature, score]) => `
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between">
                                                <span>${feature}</span>
                                                <span>${score.toFixed(1)}% (Raw: ${data.training_results.relevant_features[feature].toFixed(4)})</span>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar bg-success" role="progressbar" 
                                                     style="width: ${score}%" 
                                                     aria-valuenow="${score}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Plot feature importance
                const featureImportanceData = data.visualizations.feature_importance.data;
                const featureImportanceLayout = {
                    title: 'Feature Importance Analysis',
                    xaxis: {
                        title: 'Features',
                        tickangle: 45
                    },
                    yaxis: {
                        title: 'Importance Score'
                    },
                    margin: {
                        l: 50,
                        r: 50,
                        b: 100,
                        t: 50,
                        pad: 4
                    },
                    bargap: 0.05,
                    height: 500
                };
                Plotly.newPlot('featureImportancePlot', featureImportanceData, featureImportanceLayout);
                
                // Plot predictions vs actual
                const predictionData = data.visualizations.prediction_plot.data;
                const predictionLayout = {
                    title: 'Predicted vs Actual Values',
                    xaxis: {
                        title: 'Actual Values'
                    },
                    yaxis: {
                        title: 'Predicted Values'
                    },
                    margin: {
                        l: 50,
                        r: 50,
                        b: 50,
                        t: 50,
                        pad: 4
                    },
                    height: 500,
                    showlegend: true
                };
                Plotly.newPlot('predictionPlot', predictionData, predictionLayout);

                // Enable predictions section
                document.getElementById('predictionFile').disabled = false;
                document.querySelector('#predictionForm button').disabled = false;
                isModelTrained = true;

            } catch (error) {
                showError('trainingResults', 'Error training model: ' + error.message);
            } finally {
                hideLoader('trainingLoader');
            }
        });

        // Handle predictions
        document.getElementById('predictionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isModelTrained) return;

            const fileInput = document.getElementById('predictionFile');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            showLoader('predictionLoader');
            try {
                const response = await fetch(`${API_BASE_URL}/predict`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (!data || !data.predictions) {
                    throw new Error('Invalid response data');
                }

                const resultsContainer = document.getElementById('predictionResults');
                
                try {
                    console.log('API Response:', data);  // Debug log
                    
                    // Extract predictions and validate
                    if (!data || !data.predictions) {
                        throw new Error('Invalid response: missing predictions data');
                    }
                    
                    const predictions = data.predicted_values;
                    if (!Array.isArray(predictions) || predictions.length === 0) {
                        throw new Error('No predictions found in the response');
                    }

                    // Calculate stats from the predictions
                    const predValues = predictions.map(p => parseFloat(p.value));
                    const mean = predValues.reduce((a, b) => a + b, 0) / predValues.length;
                    const sortedVals = [...predValues].sort((a, b) => a - b);
                    
                    const stats = {
                        mean: mean,
                        std: Math.sqrt(predValues.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / (predValues.length - 1)),
                        min: sortedVals[0],
                        max: sortedVals[sortedVals.length - 1],
                        quartiles: [
                            sortedVals[Math.floor(predValues.length * 0.25)],
                            sortedVals[Math.floor(predValues.length * 0.5)],
                            sortedVals[Math.floor(predValues.length * 0.75)]
                        ],
                        count: predValues.length
                    };
                    
                    // Build the complete results HTML
                    const statsHtml = createStatsSection(stats);
                    const predictionsHtml = createPredictionsTable(data.predicted_values);
                    
                    // Create the results container with tabs
                    const resultsHtml = `
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Analysis & Visualizations</h5>
                            </div>
                            <div class="card-body">
                                <ul class="nav nav-tabs" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" data-bs-toggle="tab" href="#predictionDist">Prediction Distribution</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#featureImportance">Feature Importance</a>
                                    </li>
                                </ul>
                                <div class="tab-content mt-3">
                                    <div class="tab-pane fade show active" id="predictionDist">
                                        <div id="distributionPlot" class="plot-div"></div>
                                    </div>
                                    <div class="tab-pane fade" id="featureImportance">
                                        <div id="importancePlot" class="plot-div"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    resultsContainer.innerHTML = `
                        <div class="results-wrapper">
                            <div class="row">
                                <div class="col-12">
                                    ${statsHtml}
                                </div>
                            </div>
                            <div class="row mb-4">
                                <div class="col-12">
                                    ${resultsHtml}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Predictions</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive" style="max-height: 400px;">
                                                ${predictionsHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Create and render visualizations
                    setTimeout(() => {
                        try {
                            // Create distribution plot
                            const distTrace = {
                                x: predValues,
                                type: 'histogram',
                                name: 'Predictions',
                                nbinsx: 30
                            };
                            const distLayout = {
                                title: 'Distribution of Predictions',
                                xaxis: { title: 'Predicted Value' },
                                yaxis: { title: 'Count' }
                            };
                            Plotly.newPlot('distributionPlot', [distTrace], distLayout);

                            // Create feature importance plot if available
                            if (data.model_analysis && data.model_analysis.feature_importance) {
                                const importance = data.model_analysis.feature_importance;
                                const impTrace = {
                                    x: Object.keys(importance),
                                    y: Object.values(importance),
                                    type: 'bar',
                                    name: 'Feature Importance'
                                };
                                const impLayout = {
                                    title: 'Feature Importance Analysis',
                                    xaxis: { 
                                        title: 'Features',
                                        tickangle: 45
                                    },
                                    yaxis: { title: 'Importance Score' }
                                };
                                Plotly.newPlot('importancePlot', [impTrace], impLayout);
                            }
                        } catch (error) {
                            console.error('Error rendering plots:', error);
                        }
                    }, 100);

                    // Render plots after DOM is updated
                    setTimeout(() => {
                        if (data.visualizations) {
                            renderPlots(data.visualizations);
                        }
                    }, 100);
                } catch (error) {
                    console.error('Error updating results:', error);
                    resultsContainer.innerHTML = '<div class="alert alert-danger">Error displaying results</div>';
                }
            
            } catch (error) {
                showError('predictionResults', 'Error generating predictions: ' + error.message);
            } finally {
                hideLoader('predictionLoader');
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>